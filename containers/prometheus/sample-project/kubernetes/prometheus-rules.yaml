apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
  labels:
    app: prometheus
    component: monitoring
data:
  kubernetes.yml: |
    groups:
    - name: kubernetes.rules
      rules:
      # Kubernetes API Server
      - alert: KubernetesAPIServerDown
        expr: up{job="kubernetes-apiservers"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kubernetes API Server is down"
          description: "Kubernetes API Server has been down for more than 1 minute."

      # Kubernetes Nodes
      - alert: KubernetesNodeDown
        expr: up{job="kubernetes-nodes"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Kubernetes node is down"
          description: "Kubernetes node {{ $labels.instance }} has been down for more than 5 minutes."

      - alert: KubernetesNodeHighCPU
        expr: (100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kubernetes node has high CPU usage"
          description: "Kubernetes node {{ $labels.instance }} CPU usage is above 80% for more than 5 minutes."

      - alert: KubernetesNodeHighMemory
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kubernetes node has high memory usage"
          description: "Kubernetes node {{ $labels.instance }} memory usage is above 80% for more than 5 minutes."

      - alert: KubernetesNodeDiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kubernetes node has low disk space"
          description: "Kubernetes node {{ $labels.instance }} disk usage is above 80% for more than 5 minutes."

      # Kubernetes Pods
      - alert: KubernetesPodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kubernetes pod is crash looping"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is crash looping."

      - alert: KubernetesPodNotReady
        expr: kube_pod_status_phase{phase!="Running",phase!="Succeeded"} > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kubernetes pod is not ready"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is not ready."

      # Kubernetes Deployments
      - alert: KubernetesDeploymentReplicasMismatch
        expr: kube_deployment_status_replicas_available != kube_deployment_spec_replicas
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kubernetes deployment replicas mismatch"
          description: "Deployment {{ $labels.deployment }} in namespace {{ $labels.namespace }} has {{ $value }} available replicas but {{ $labels.replicas }} desired."

      # Kubernetes Services
      - alert: KubernetesServiceDown
        expr: up{job="kubernetes-services"} == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kubernetes service is down"
          description: "Service {{ $labels.kubernetes_name }} in namespace {{ $labels.kubernetes_namespace }} is down."

  application.yml: |
    groups:
    - name: application.rules
      rules:
      # General Application Health
      - alert: ApplicationDown
        expr: up{job=~".*"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Application is down"
          description: "Application {{ $labels.job }} on {{ $labels.instance }} has been down for more than 1 minute."

      - alert: ApplicationHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Application has high error rate"
          description: "Application {{ $labels.job }} on {{ $labels.instance }} has error rate above 10% for more than 5 minutes."

      - alert: ApplicationHighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Application has high response time"
          description: "Application {{ $labels.job }} on {{ $labels.instance }} has 95th percentile response time above 1 second for more than 5 minutes."

      # MinIO Specific
      - alert: MinIODown
        expr: up{job="minio"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MinIO is down"
          description: "MinIO instance {{ $labels.instance }} has been down for more than 1 minute."

      - alert: MinIOHighCPU
        expr: rate(container_cpu_usage_seconds_total{container="minio"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MinIO has high CPU usage"
          description: "MinIO instance {{ $labels.instance }} CPU usage is above 80% for more than 5 minutes."

      - alert: MinIOHighMemory
        expr: container_memory_usage_bytes{container="minio"} / container_spec_memory_limit_bytes > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MinIO has high memory usage"
          description: "MinIO instance {{ $labels.instance }} memory usage is above 80% for more than 5 minutes."

      - alert: MinIOStorageFull
        expr: minio_disk_usage_percentage > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MinIO storage is almost full"
          description: "MinIO instance {{ $labels.instance }} storage usage is above 80% for more than 5 minutes."

      # PostgreSQL Specific
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL instance {{ $labels.instance }} has been down for more than 1 minute."

      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL has high connection usage"
          description: "PostgreSQL instance {{ $labels.instance }} connection usage is above 80% for more than 5 minutes."

      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_database_tup_returned[5m]) / rate(pg_stat_database_tup_fetched[5m]) < 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL has slow queries"
          description: "PostgreSQL instance {{ $labels.instance }} has slow query performance for more than 5 minutes."

      # Node Exporter
      - alert: NodeExporterDown
        expr: up{job="node-exporter"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Node Exporter is down"
          description: "Node Exporter on {{ $labels.instance }} has been down for more than 1 minute."

      - alert: NodeHighLoad
        expr: node_load1 > 4
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Node has high load"
          description: "Node {{ $labels.instance }} has load average above 4 for more than 5 minutes."

      - alert: NodeDiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Node has low disk space"
          description: "Node {{ $labels.instance }} disk usage is above 80% for more than 5 minutes."

      # cAdvisor
      - alert: ContainerHighCPU
        expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container has high CPU usage"
          description: "Container {{ $labels.name }} on {{ $labels.instance }} has CPU usage above 80% for more than 5 minutes."

      - alert: ContainerHighMemory
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container has high memory usage"
          description: "Container {{ $labels.name }} on {{ $labels.instance }} has memory usage above 80% for more than 5 minutes."

      - alert: ContainerRestarting
        expr: rate(container_start_time_seconds[5m]) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Container is restarting frequently"
          description: "Container {{ $labels.name }} on {{ $labels.instance }} is restarting frequently."
